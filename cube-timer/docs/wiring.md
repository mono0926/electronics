# 回路設計 & 電子回路の基礎知識

このドキュメントでは、スピードキューブ・タイマーの回路設計と、使われている電子部品の原理を初心者向けに解説します。

## 目次

1. [全体の回路構成](#1-全体の回路構成)
2. [Arduino Nano — 頭脳](#2-arduino-nano--頭脳)
3. [TTP223 タッチセンサー — 手の検知](#3-ttp223-タッチセンサー--手の検知)
4. [OLED ディスプレイ — 表示](#4-oled-ディスプレイ--表示)
5. [キーボードスイッチ — リセットボタン](#5-キーボードスイッチ--リセットボタン)
6. [アクティブブザー — 音](#6-アクティブブザー--音)
7. [トグルスイッチ — 電源](#7-トグルスイッチ--電源)
8. [デバウンスとは？](#8-デバウンスとは)
9. [プルアップ抵抗とは？](#9-プルアップ抵抗とは)
10. [I2C通信とは？](#10-i2c通信とは)
11. [パスコン（バイパスコンデンサー）について](#11-パスコンバイパスコンデンサーについて)

---

## 1. 全体の回路構成

```
                    ┌───────────────┐
                    │  Arduino Nano │
                    │               │
  [トグルSW]──VIN──→│ VIN       5V  │──→ OLED VCC / タッチVCC / ブザーVCC
         GND──→│ GND      GND  │──→ OLED GND / タッチGND / ブザーGND
                    │               │
  タッチ(左)───→│ D2        A4  │──→ OLED SDA (データ)
  タッチ(右)───→│ D3        A5  │──→ OLED SCL (クロック)
  リセットSW───→│ D4             │
                    │ D8            │──→ ブザー
                    └───────────────┘
```

### なぜこの構成なの？

この回路は**たった5つの部品**をArduino Nanoに繋ぐだけのシンプルな構成です。

Arduino Nano が「頭脳」として全体を制御します:

- タッチセンサーとスイッチからの**入力**を読み取って
- OLEDとブザーに**出力**する

電子回路の基本は、この「入力 → 処理 → 出力」のパターンです。

---

## 2. Arduino Nano — 頭脳

### これは何？

Arduino Nanoは**マイコンボード**です。マイコン（マイクロコントローラー）とは、小さなコンピューターのこと。CPU、メモリ、入出力ピンが1つのチップに入っています。

### スペック

| 項目             | 値              | 解説                                           |
| :--------------- | :-------------- | :--------------------------------------------- |
| MCU              | ATmega328P      | 16MHz で動く8ビットCPU                         |
| デジタルI/O      | 14ピン (D0-D13) | HIGH(5V) or LOW(0V) のオン/オフ信号            |
| アナログ入力     | 8ピン (A0-A7)   | 0〜5Vの電圧を0〜1023の数値に変換               |
| フラッシュメモリ | 32KB            | プログラムを保存する場所                       |
| SRAM             | 2KB             | プログラム実行中に使う一時メモリ               |
| EEPROM           | 1KB             | 電源を切っても消えないメモリ（記録保存に使う） |
| 動作電圧         | 5V              | USBから5V、VINからは7-12Vを受け付ける          |

### なぜ Arduino Nano？

- **安い:** 互換品なら¥500前後
- **簡単:** Arduino IDEでプログラムを書いてUSBで書き込むだけ
- **十分な性能:** 16MHzのクロックで`millis()`関数を使えば、ミリ秒精度のタイマーに十分
- **ちょうど良い大きさ:** 18×45mm。筐体に収まるコンパクトさ

### クロック精度について

「タイマーとしてミリ秒精度って大丈夫？」という疑問があるかもしれません。

Arduino Nanoのクロックは16MHzのセラミック発振子（レゾネーター）を使っています。精度は約±0.5%で、10秒あたり±50ミリ秒の誤差です。スピードキューブの公式大会ではStackmatタイマーの精度は±0.01秒とされているので、この用途には十分です。

もし将来的にもっと精度が欲しくなったら、外付けのクリスタル発振子（±0.002%）に交換することもできます。

---

## 3. TTP223 タッチセンサー — 手の検知

### これは何？

TTP223は**静電容量方式のタッチセンサーIC**です。指が触れると電気信号が変わることを検知します。

### 原理: 静電容量方式タッチセンサー

```
触れていない時:            触れている時:
┌─────────┐              ┌─────────┐
│ センサー │              │ 💧 指   │
│ パッド   │              │ センサー │
└─────────┘              │ パッド   │
  容量: 小さい            └─────────┘
  → LOW出力                容量: 大きくなる
                           → HIGH出力
```

**静電容量（キャパシタンス）** とは、電荷を蓄える能力のことです。

1. タッチパッドは小さな金属板（コンデンサーの片方の電極）
2. 何も触れていない時は、パッドと周囲の間の静電容量は小さい
3. 人間の指は水分を含んでいて導電性がある
4. 指が近づくと、パッド-指間で新たなコンデンサーが形成される
5. 静電容量が増加する → TTP223がこの変化を検知 → HIGH(3.3V)を出力

> 💡 **スマホのタッチスクリーンも同じ原理**です。もっと細かいグリッドで指の位置を特定しています。

### TTP223 の仕様

| 項目     | 値                             |
| :------- | :----------------------------- |
| 動作電圧 | 2.0V〜5.5V                     |
| 出力     | タッチ時 HIGH / 非タッチ時 LOW |
| 反応時間 | 約60ms (速い！)                |
| 消費電力 | 約8μA (非常に省電力)           |

### 接続方法

```
TTP223 モジュール (3ピン):
┌──────────┐
│  VCC ─────→ Arduino 5V
│  GND ─────→ Arduino GND
│  SIG ─────→ Arduino D2 (左手) / D3 (右手)
└──────────┘
```

VCC(電源)、GND(グランド)、SIG(信号)の3本だけ。シンプルです。

### なぜタッチセンサー？

スイッチではなくタッチセンサーを選んだ理由:

- **Stackmat G5と同じ操作感:** 手を「置く/離す」だけ。スイッチの「押し込む」動作が不要
- **反応速度:** 60msの反応時間は十分速い（人間の反応時間は約200ms）
- **耐久性:** 機械的な可動部がないので壊れにくい
- **防水性:** 汗ばんだ手でも問題なく動作する

### タッチ面の拡大

TTP223モジュールのタッチパッドは直径約11mmと小さいです。手のひら全体で触れるStackmat風にするには、**銅テープ**をパッドに貼り付けて接触面を広げます。

```
銅テープで拡大したタッチパッド:
┌────────────────────┐
│                    │
│    銅テープ         │  ← 50mm×50mm程度に広げる
│    (導電性あり)     │
│         ┌────┐     │
│         │TTP │     │  ← 元のセンサーは裏側に
│         │223 │     │
│         └────┘     │
│                    │
└────────────────────┘
```

銅テープの面積が大きいほど検出感度が上がりますが、大きすぎると誤検知の原因になります。50mm×50mm程度がちょうど良い大きさです。

---

## 4. OLED ディスプレイ — 表示

### これは何？

OLED (Organic Light-Emitting Diode = 有機発光ダイオード) ディスプレイは、各ピクセルが自分自身で発光する表示装置です。

### 液晶 vs OLED

|              | 液晶 (LCD)           | OLED                               |
| :----------- | :------------------- | :--------------------------------- |
| バックライト | 必要                 | **不要（自発光）**                 |
| コントラスト | 普通                 | **非常に高い（黒が本当に真っ黒）** |
| 視野角       | 狭い                 | **広い**                           |
| 消費電力     | 常にバックライト点灯 | **表示内容による（黒は消費ゼロ）** |
| 応答速度     | やや遅い             | **速い**                           |

タイマー表示には「数字がくっきり見える」「斜めからも読める」OLEDが最適です。

### SSD1306 コントローラー

今回使う OLED モジュールには **SSD1306** というコントローラーICが搭載されています。

| 項目             | 値                  |
| :--------------- | :------------------ |
| 解像度           | 128×64 ピクセル     |
| 表示色           | 単色 (白 or 青)     |
| インターフェース | I2C (2本の線で通信) |
| 動作電圧         | 3.3V〜5V            |
| I2Cアドレス      | 0x3C (一般的)       |

### 接続方法

```
OLED モジュール (4ピン):
┌──────────┐
│  VCC ─────→ Arduino 5V
│  GND ─────→ Arduino GND
│  SDA ─────→ Arduino A4 (データ線)
│  SCL ─────→ Arduino A5 (クロック線)
└──────────┘
```

I2C通信についての詳細は [10. I2C通信とは？](#10-i2c通信とは) を参照。

---

## 5. キーボードスイッチ — リセットボタン

### これは何？

Cherry MX互換のメカニカルキーボードスイッチです。キーボードの各キーに1個ずつ入っている部品です。

### スイッチの仕組み

```
押していない時:          押した時:
┌─────────┐           ┌─────────┐
│  キャップ │           │  キャップ │ ← 押し下げる
│ ┌──┐     │           │ ┌──┐     │
│ │  │バネ  │           │ │/│バネ   │ ← バネが縮む
│ │  │     │           │ │ │     │
│ ┌──┐     │           │ ┌──┐     │
│ │  │接点  │           │ │■■│接点  │ ← 金属接点が接触 → 導通!
│ └──┘     │           │ └──┘     │
└─────────┘           └─────────┘
  回路: 開 (OFF)          回路: 閉 (ON)
```

基本的には**2本の金属が触れるか離れるか**だけのシンプルな仕組みです。

### 電気的な接続

```
Arduino D4 ──── [スイッチ] ──── GND

D4ピンは INPUT_PULLUP モードに設定:
- スイッチ開 (押していない): D4 = HIGH (5V)  ← 内部プルアップ抵抗が5Vに引き上げ
- スイッチ閉 (押した):       D4 = LOW (0V)   ← GNDに直結されるので0V
```

プルアップ抵抗の詳しい仕組みは [9. プルアップ抵抗とは？](#9-プルアップ抵抗とは) を参照。

### なぜキーボードスイッチ？

リセットボタンにはタクトスイッチ（小さな基板実装ボタン）でも良いのですが:

- 手持ちのスイッチを活用できる
- **カチッとした触覚フィードバック**があり、「押した」ことが確実に分かる
- キーキャップを付けられるので、操作しやすい
- 誤操作で押してしまわないよう、意図的な押下が必要

---

## 6. アクティブブザー — 音

### これは何？

電圧をかけるだけで音が鳴る素子です。

### アクティブ vs パッシブブザー

|          | アクティブブザー       | パッシブブザー            |
| :------- | :--------------------- | :------------------------ |
| 回路     | **発振回路内蔵**       | 外部から信号が必要        |
| 使い方   | **5Vかけるだけで鳴る** | 特定周波数のPWM信号を送る |
| 音の種類 | 固定音（ピーッ）       | 音階を奏でられる          |
| 難易度   | **超簡単**             | やや複雑                  |

今回はスタート/ストップの通知音だけなので、アクティブブザーで十分です。

### 発振回路って？

アクティブブザーの中には**発振回路**が入っています。

```
電圧をかける → 発振回路が電気信号を振動に変換 → 圧電素子が振動 → 空気が振動 → 音
```

圧電素子（ピエゾ素子）は、電圧をかけると形が変わる特殊なセラミック。これが高速で伸び縮みすることで空気を振動させ、音として聞こえます。一般的なアクティブブザーの周波数は約2kHz〜4kHz（ピーッという音）です。

### 接続方法

```
Arduino D8 ────── ブザー (+)
Arduino GND ───── ブザー (-)

※ アクティブブザーは極性あり（+/-を間違えないこと）
   長い足が (+)、短い足が (-) です
```

### なぜ D8 ピンから直接駆動できるの？

Arduino Nano の各ピンは最大 40mA の電流を出力できます。一般的なアクティブブザーの消費電流は 25〜30mA なので、トランジスタ等を介さずに直接駆動できます。

> ⚠️ **注意:** もし LED を大量につなぐ場合など、1ピンあたり40mAを超える場合はトランジスタで電流を増幅する必要があります。今回は不要です。

---

## 7. トグルスイッチ — 電源

### これは何？

レバーを倒してON/OFFを切り替えるスイッチです。SPST（Single Pole Single Throw）タイプを使います。

### SPST って何？

スイッチの分類は「極数 (Pole)」と「投数 (Throw)」で表します:

```
SPST (Single Pole, Single Throw):
──[/]── 1つの回路を ON/OFF するだけ。最もシンプル。

SPDT (Single Pole, Double Throw):
──[/]──┬── 1つの入力を2つの出力先に切り替える。
       └──

DPST (Double Pole, Single Throw):
──[/]── 2つの回路を同時にON/OFFする。
──[/]──
```

今回は電源の ON/OFF だけなので SPST で十分です。

### 接続方法

```
USB or 電池 (+) ────[トグルスイッチ]──── Arduino VIN
USB or 電池 (-) ──────────────────────── Arduino GND
```

> 💡 **USB給電時の注意:** USB-C ケーブルで直接 Arduino の USB ポートに繋ぐ場合、トグルスイッチは不要です（USBを抜けば電源OFF）。トグルスイッチは電池駆動にする時に本領を発揮します。

---

## 8. デバウンスとは？

### 問題: チャタリング

メカニカルスイッチを押した瞬間、金属接点が高速でバウンド（跳ね返り）します。

```
理想的なスイッチの波形:        実際のスイッチの波形:

HIGH ────┐              HIGH ────┐ ┌┐ ┌┐
         │                       │ ││ ││
LOW      └──────        LOW      └─┘└─┘└──────
         ↑                       ↑
      1回の変化                バウンドが数回発生！
                              (約1〜10ミリ秒間)
```

Arduino は非常に高速なので、このバウンドを「複数回押された」と誤認識してしまいます。

### 解決: ソフトウェアデバウンス

「状態が変わってから一定時間（例: 50ms）待って、まだ同じ状態なら確定」とする方法です。

```c
// デバウンスの考え方
unsigned long lastDebounceTime = 0;
const unsigned long DEBOUNCE_DELAY = 50; // 50ミリ秒

if (ボタンの状態が変わった) {
    lastDebounceTime = millis(); // 現在時刻を記録
}

if (millis() - lastDebounceTime > DEBOUNCE_DELAY) {
    // 50ms以上同じ状態が続いた → 本当に押された/離されたと確定
}
```

### ハードウェアデバウンス（参考）

コンデンサーを使ってバウンドの電圧変動を滑らかにする方法もあります:

```
Arduino D4 ──┬── [スイッチ] ── GND
             │
             └── [0.1μFコンデンサー] ── GND
```

コンデンサーが急激な電圧変動を吸収し、なめらかな波形にします。ただし今回はソフトウェアデバウンスで十分なので、追加部品は不要です。

> 💡 **タッチセンサー TTP223 ではデバウンス不要:** TTP223は内部でデバウンス処理をしているため、出力は安定しています。デバウンスが必要なのはメカニカルスイッチ（リセットボタン）だけです。

---

## 9. プルアップ抵抗とは？

### 問題: 浮遊状態

スイッチが押されていない時、Arduino の入力ピンはどこにも繋がっていない「浮遊状態」になります。

```
浮遊状態 (ダメな例):
Arduino D4 ──── [スイッチ] ──── GND

スイッチが開いている時、D4 は HIGHT? LOW? → 不定！
ノイズを拾ってランダムに HIGH/LOW が変わってしまう
```

### 解決: プルアップ抵抗

抵抗器で電源(5V)に「引き上げ(Pull-Up)」ておきます。

```
プルアップ抵抗 (手動):
         5V
          │
       [10kΩ] ← プルアップ抵抗
          │
Arduino D4 ──┬── [スイッチ] ──── GND
             │
            ここの電圧を読む

スイッチ開: 10kΩ経由で5Vに繋がる → D4 = HIGH (確定)
スイッチ閉: GNDに直結される     → D4 = LOW  (確定)
```

### なぜ10kΩ？

- **抵抗が小さすぎる (例: 100Ω):** スイッチを押した時に大電流が流れて無駄な電力消費。5V ÷ 100Ω = 50mA も流れる！
- **抵抗が大きすぎる (例: 1MΩ):** ノイズに弱くなり、正確な読み取りが難しくなる
- **10kΩがちょうど良い:** スイッチ押下時の電流は 5V ÷ 10kΩ = 0.5mA。省電力でノイズにも十分強い

### Arduino の内蔵プルアップ

Arduino には各ピンに **内蔵プルアップ抵抗（約20kΩ〜50kΩ）** が搭載されています。

```c
pinMode(D4, INPUT_PULLUP); // これだけで内蔵プルアップを有効化！
```

外付け抵抗が不要になるので、部品点数を減らせます。今回のリセットスイッチはこれを使います。

---

## 10. I2C通信とは？

### 概要

I2C (Inter-Integrated Circuit、読み: アイ・スクエアド・シー or アイ・ツー・シー) は、**2本の線だけで複数デバイスと通信できる**プロトコルです。

```
Arduino (マスター)
  │
  ├── SDA (A4) ───────┬──── OLED (スレーブ1)
  │                    ├──── センサーA (スレーブ2)  ← 将来追加も簡単
  │                    └──── センサーB (スレーブ3)  ← 同じ2本に繋ぐだけ
  └── SCL (A5) ───────┘
```

### 2本の線

| 線      | 名前         | 役割                         |
| :------ | :----------- | :--------------------------- |
| **SDA** | Serial Data  | データの送受信               |
| **SCL** | Serial Clock | 通信のタイミング（クロック） |

### 通信の仕組み (簡略)

1. **マスター(Arduino)** がクロック信号(SCL)を送る
2. クロックに同期して、データ(SDA)をビットごとに送る
3. 各デバイスには **固有のアドレス** がある（OLEDは 0x3C）
4. マスターがアドレスを指定して「おーい、0x3Cのデバイス！」と呼びかける
5. 該当するデバイスだけが応答する

### なぜ I2C を使うの？

- **配線が少ない:** たった2本で通信できる（SPIは4本必要）
- **拡張が簡単:** 同じ2本の線に複数デバイスを接続できる
- **Arduino標準対応:** `Wire` ライブラリが標準搭載

---

## 11. パスコン（バイパスコンデンサー）について

### コンデンサーとは？

コンデンサー（キャパシター）は**電荷を蓄える部品**です。

```
構造:
      ┌─── 金属板A (電極)
      │ ┌─ 絶縁体 (誘電体)
      │ │ ┌ 金属板B (電極)
 ──┤│├──

2枚の金属板の間に絶縁体を挟んだ構造。
電圧をかけると、片方の板に (+)、もう片方に (-) の電荷が溜まる。
```

### 水タンクのアナロジー

```
電源 = 水道管       コンデンサー = 小さなタンク      回路 = 蛇口

通常時:
  水道管 ──→ 🪣タンク(満) ──→ 🚰蛇口
              安定した水量を維持

水圧が一瞬下がった時:
  水道管 ─✕→ 🪣タンク(放水) ──→ 🚰蛇口
              タンクの貯水で蛇口の水量を維持！
```

コンデンサーは**電気の小さなバッテリー**のようなもの。電源が一瞬不安定になっても、溜めた電荷を放出して電圧を安定させます。

### パスコン（バイパスコンデンサー）って？

ICの電源ピン(VCC)のそばに置く小さなコンデンサーのことです。

```
【パスコンなし】
5V ──────────── IC VCC    ← 配線が長いとノイズが乗る
                IC GND ──── GND

【パスコンあり】
5V ──────┬───── IC VCC    ← ICのすぐそばにコンデンサー
         │
       [0.1μF] ← パスコン！
         │
GND ─────┴───── IC GND
```

### なぜ 0.1μF（100nF）が定番なの？

コンデンサーの容量は周波数特性に関係します:

- IC内部のスイッチングで発生するノイズは**数MHz〜数十MHz**の高周波
- 0.1μFのセラミックコンデンサーは、この周波数帯で最も効果的にノイズを吸収する
- 大きすぎる容量（例: 100μF）は高周波ノイズには効かない（低周波向き）
- 小さすぎる容量（例: 100pF）では蓄えられる電荷が少なすぎて安定化効果が弱い

> 📏 **覚えるルール:** 「ICの電源ピンには0.1μFのパスコン」— これは電子工作の世界でほぼ鉄則。

### 今回のプロジェクトでは？

Arduino Nano ボード上にはすでにパスコンが搭載されているので、**追加のパスコンは基本的に不要**です。

ただし、ブレッドボードで配線が長くなった場合や、OLEDの表示がチラつく場合は、OLED の VCC-GND 間に 0.1μF のセラミックコンデンサーを追加すると改善することがあります。

---

## まとめ: 部品選定の理由

| 部品                  | 選定理由                                                 |
| :-------------------- | :------------------------------------------------------- |
| Arduino Nano          | 安価、簡単、ミリ秒精度タイマーに十分、コンパクト         |
| TTP223                | Stackmat風の「触れる/離す」操作、反応速度60ms、3線接続   |
| SSD1306 OLED          | I2Cで2線接続、高コントラスト、省電力、斜めからも見やすい |
| キーボードスイッチ    | カチッとした触覚フィードバック、手持ち活用、誤操作防止   |
| アクティブブザー      | 電圧かけるだけで鳴る、追加回路不要                       |
| トグルスイッチ (SPST) | 最もシンプルな電源ON/OFF                                 |
