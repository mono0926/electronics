# トラブルシューティング & FAQ (Troubleshooting & FAQ)

部品の組み立て中や完成後に発生しやすい問題とその解決策をまとめました。
「あれ？おかしいな」と思ったら、まずはここを確認してください。

---

## 🛑 ハードウェアのトラブル

### Q: LEDが全く光らない！

**A: 以下の順に電気と信号の流れを確認してください。**

1. **コンセント**: ACアダプタは正しく挿さっていますか？
2. **通電**: ラズパイの電源LED（緑色）は点滅／点灯していますか？もし付いていなければ、5Vがラズパイに届いていません。
3. **極性の確認**: ACアダプタのプラスとマイナスを逆に繋いでいませんか？（ヒューズが飛んでいる可能性があります。目視で確認してください）
4. **GNDの共通化**: 最も多いミスです。LEDのGND（マイナス）と、ラズパイのGNDは直接繋がっていますか？
5. **信号の向き**: LEDテープの接続向きを確認してください。`▶` または `→` の刻印の「始まり」にケーブルを繋いでいますか？

### Q: LEDの末端部分の色が変（赤・黄色っぽくなる）

**A: 電圧降下が発生しています。**

- 144LED/mなどの高密度テープをフルパワーで光らせると、末端に行くにつれて電圧が下がり青色が出にくくなります。
- **基本対策**: Web UIの「Settings」タブでBrightness（明るさ）を50%以下に下げることで回避できます（[オリジナルプロジェクト（onlaj版）](https://github.com/mono0926/Piano-LED-Visualizer/tree/ja)の標準設定）。
- **発展対策（オプション）**: もし100%の明るさで安定して光らせたい場合は、追加の配線工事である `Power Injection（電力注入）` システムの構築がお勧めです。詳細は [配線ガイド](../hardware/wiring.md) を参照してください。

### Q: 色が勝手に激しく点滅する / チラつく

**A: 信号レベルが不安定か、ノイズが混入しています。**

- **レベルシフターを使用していますか？** ラズパイの3.3V信号では正しく制御できません。74AHCT125N を経由しているか確認してください。
- レベルシフターの `1OE` ピン（Pin 1）が確実に GND に落ちているか確認してください。
- 信号の反射を防ぐため、レベルシフターの出力と LEDの間に `330Ω` の抵抗を挟んでいますか？
- ラズパイからレベルシフター、LEDまでの配線（DIN）が長すぎませんか？10〜20cm以内に収めるのが理想的です。

### Q: 電源を入れるとラズパイが何度も再起動する / 落ちる

**A: 電圧変動（電力不足）のサインです。**

- LEDが光った瞬間に急激に電流が引き抜かれ、ラズパイを動かすための電圧が低下しています。
- 電源と並列に **1000μF 程度の電解コンデンサ**を取り付けていますか？電圧を安定させる「ダム」の役割として必須です。
- ACアダプタの容量は十分ですか？144LED/mの場合、6A以上を推奨します。

---

## 💻 ソフトウェアのトラブル

### Q: ピアノの鍵盤を叩いても光が反応しない

**A: MIDI信号がラズパイに届いていないか、プログラムが認識していません。**

1. ピアノとラズパイがUSBケーブルで正しく繋がっているか確認します。
2. ブラウザで `http://pianoledvisualizer.local` にアクセスします。
3. **Ports** タブを開き、接続されているピアノのデバイス名が表示されているか確認します。表示されていれば、そのデバイスを選択して「Save」を押してください。
4. **Logs** タブを開いた状態でピアノを弾いてください。「NoteOn」などのメッセージが流れない場合は、ケーブルの不良か、ピアノ側の設定（Local Controlなど）を確認してください。

### Q: Web設定画面（`http://pianoledvisualizer.local`）が開けない

**A: ネットワークの接続問題です。**

1. ラズパイとスマートフォン/PCが**同じWi-Fiルーター**に繋がっているか確認してください。
2. 起動直後（数分間）はバックグラウンドプロセスが立ち上がっていない場合があります。しばらく待ってからリロードしてください。
3. ルーターの設定（プライバシーセパレーター等のクライアント間通信ブロック機能）が有効になっている場合は無効にしてください。
4. `pianoledvisualizer.local` でアクセスできない場合は、ルーターの管理画面などでラズパイに割り当てられたIPアドレス（例: `192.168.1.15`）を確認し、直接IPアドレスでアクセスしてみてください。

---

## 🎹 演奏中のトラブル

### Q: 弾いた鍵盤と、光るLEDの位置がズレている

**A: Web設定でのマッピングが必要です。**

- **Settings** タブの `Shift` の値を調整してください（数値を増減させて、中央の「ド(C4)」がぴったり合うようにします）。
- 左右が完全に逆になっている場合は、`Reverse` にチェックを入れてください。
- 光る範囲のピッチが合わない場合は `LED Count`（LEDの総数）が正しく入力されているか確認してください。

### Q: 演奏のテンポが速いと、光が追いつかない（遅延を感じる）

**A: 処理負荷を下げてレイテンシを改善します。**

1. **Brightness**（明るさ）を少し下げてみてください。
2. ラズパイ 3B / Zero W (初代) などの古いモデルを使用している場合、処理性能の限界の可能性があります。（**Zero 2 W** を強く推奨します）
3. バックグラウンドアニメーションを使用している場合は、単体のVelocity（ベロシティ）モードなどに切り替えて負荷を評価してください。
