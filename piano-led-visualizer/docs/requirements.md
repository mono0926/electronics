# 技術的解説・要件定義 (Technical Requirements & Concepts)

本プロジェクトは、MIDI（Musical Instrument Digital Interface）とアドレサブルLEDを組み合わせた、リアルタイム視覚化システムです。単に「光る」だけでなく、演奏体験を損なわない高い応答性と安定性が求められます。

## 1. 動作の仕組み (Logical Flow)

システムは以下の3段階で動作します：

1.  **MIDIイベントの受信**: 電子ピアノから `NoteOn` (鍵盤を押した) または `NoteOff` (鍵盤を離した) メッセージを取得します。
2.  **写像 (Mapping)**: MIDIノート番号（0〜127）を、物理的なLEDの番号（インデックス）に変換します。
3.  **LED出力**: WS2812B用プロトコルに変換し、GPIO経由でシリアル信号を送信して点灯させます。

## 2. MIDIプロトコルの詳細

電子ピアノが送信するMIDIデータには、主に以下の情報が含まれます：

- **Note Number**: どの鍵盤か（21〜108が標準的な88鍵の範囲）。
- **Velocity**: どのくらいの強さで叩いたか。これを「色」や「輝度」に反映させることで、表現力豊かな視覚化が可能になります。

## 3. 電気的特性と安定化 (Electrical Stability)

本システムにおける最大の技術的挑戦は「電力供給」です。

- **電圧降下 (Voltage Drop)**: テープの素材（銅箔）には抵抗があるため、電流が流れるほど電圧が下がります。これにより末端のLEDが赤っぽくなったり不点灯になったりします。
  - **元のリポジトリ (onlaj版) のアプローチ**: シンプルな「片端給電」ですが、ソフトウェア側で **最大輝度を50%以下に制限** することで電圧降下を実用範囲内に抑えています。
  - **本プロジェクト独自のアプローチ（さらなる改善）**: 基本はオリジナル同様にソフトウェアの輝度制限で対応可能ですが、100%輝度の表現や動作の完全な安定性を確保するための独自のアップグレード（オプション）として、「**Power Injection（電力注入）**」の実装もガイドに残しています。
    - **対策**: 片端給電ではなく、両端、または一定間隔ごとに給電点（電力の入り口）を設けます。
- **突入電流**: 電源投入時に大量の電流が流れ、LED内部のICを破壊することがあります。
  - **対策**: 電源ラインの直近に **1000μF程度の電解コンデンサ** を配置し、波形を平滑化します。

## 4. 低レイテンシの実現

演奏と光がズレると違和感が生じるため、システム全体の遅延を最小限にする必要があります。

- **Raspberry Pi OS**: リアルタイム性を高めるため、余計なGUIやサービスを省いた `Lite` イメージの使用、または `onlaj`氏の最適化済みプリビルドイメージが有効です。
- **Pythonの最適化**: 信号処理に `numpy` 等を使用し、高密度なLEDの更新レート（リフレッシュレート）を維持します。
