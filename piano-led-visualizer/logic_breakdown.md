# Piano-LED-Visualizer 内部ロジック解説

このドキュメントでは、Piano-LED-Visualizer のコアロジック（LED配置の計算やMIDIイベント処理）について、エンジニア向けの視点で解説します。

## 1. LED配置とキーの対応ロジック

MIDIノート番号（0〜127）をLEDストリップ上のインデックスに変換する計算は、`lib/functions.py` の `get_note_position` 関数で行われています。

### 基本計算式

```python
density = leds_per_meter / 72
note_pos_raw = int(density * (note - 20) - note_offset)
```

### パラメータの解説

- **`leds_per_meter`**: 使用するLEDストリップの密度（例: 144 LEDs/m）。
- **`72` (基準密度)**: 標準的なピアノの1メートルあたりの鍵盤数（88鍵 / 約1.22m ≒ 72）を指す定数です。これによって、どんな密度のLEDストリップでも鍵盤位置が合うように比率が計算されます。
  - `144 / 72 = 2.0` なら、1つの鍵盤に2個のLEDが割り当たります。
- **`- 20`**: ピアノの88鍵盤の最初の音（A0）はMIDIノート番号 `21` です。これをインデックス `1` 付近に持ってくるためのオフセットです。
- **`note_offset`**: 特定のノート範囲ごとに累積する物理的なズレを補正するためのリスト（`settings.xml` の `note_offsets`）。

### 最終的な調整

計算された `note_pos_raw` に対して、以下のグローバル設定が適用されます。

- **`shift`**: 全体を左右にずらす補正値。
- **`reverse`**: ストリップの向きが逆の場合の反転処理。

## 2. MIDIイベントの処理

`lib/midi_event_processor.py` がMIDI信号を解析し、描画命令に変換します。

### バースト処理 (Coalescing)

高速な演奏でも描画がカクつかないよう、1.5ms以内の短い間隔で届いたメッセージをまとめ、一度のループで処理します。これにより、和音などの同時打鍵もスムーズに描画されます。

### モード別の描画ロジック (`handle_note_on`)

- **Velocityモード**: 打鍵速度（0〜127）を輝度（0.0〜1.0）としてマッピングします。
- **Fadingモード**: キーを離した際、即座に消灯せず、設定された `fadingspeed` に基づいて徐々に暗くします。
- **Pulseモード**: キーを押した位置から光の波が広がるエフェクトを生成します。

## 3. 外部ソフトウェアとの連携

Synthesia などの外部ソフトがMIDIチャンネル `11` (左手) や `12` (右手) で信号を送ってきた場合、`is_external_software` フラグが立ち、ソフト側で指定された色でLEDが制御されます。

---

このロジックを理解することで、異なるピッチのLEDストリップ（30/60/144 LEDs/m）や、特殊な鍵盤構成へのカスタマイズが可能になります。
